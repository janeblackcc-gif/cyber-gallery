<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cyber Gallery ä¸Šä¼ </title>
    <style>
      :root {
        color-scheme: light;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 32px;
        background: #fafaf9;
        color: #292524;
      }
      .card {
        max-width: 720px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin: 0 0 24px;
        font-size: 28px;
        font-weight: 600;
        color: #1c1917;
      }
      label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin: 16px 0 8px;
        color: #57534e;
      }
      input[type="text"],
      input[type="date"],
      textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d6d3d1;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.2s;
      }
      input[type="text"]:focus,
      input[type="date"]:focus,
      textarea:focus {
        outline: none;
        border-color: #78716c;
      }
      textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
      }
      input[type="file"] {
        display: block;
        width: 100%;
        padding: 12px;
        border: 2px dashed #d6d3d1;
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.2s;
      }
      input[type="file"]:hover {
        border-color: #a8a29e;
      }
      .preview {
        margin-top: 20px;
        padding: 16px;
        border: 1px dashed #d6d3d1;
        border-radius: 8px;
        background: #fafaf9;
        text-align: center;
        color: #78716c;
      }
      .preview img,
      .preview video {
        max-width: 100%;
        max-height: 400px;
        display: block;
        margin: 0 auto;
        border-radius: 4px;
      }
      .actions {
        margin-top: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      button {
        background: #1c1917;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover:not(:disabled) {
        background: #292524;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      progress {
        flex: 1;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }
      progress::-webkit-progress-bar {
        background: #e7e5e4;
        border-radius: 4px;
      }
      progress::-webkit-progress-value {
        background: #1c1917;
        border-radius: 4px;
      }
      .status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
      }
      .status.show {
        display: block;
      }
      .status.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      .status.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .status.info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }
      .status a {
        color: inherit;
        font-weight: 600;
      }
      .file-info {
        margin-top: 8px;
        font-size: 12px;
        color: #78716c;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ğŸ“· Cyber Gallery ä¸Šä¼ </h1>
      <form id="upload-form">
        <label for="title">æ ‡é¢˜ *</label>
        <input id="title" type="text" placeholder="è¾“å…¥ä½œå“æ ‡é¢˜" required />

        <label for="date">æ—¥æœŸ</label>
        <input id="date" type="date" />

        <label for="desc">æè¿°</label>
        <textarea id="desc" placeholder="ç®€çŸ­æè¿°è¿™ä¸ªä½œå“"></textarea>

        <label for="file">åª’ä½“æ–‡ä»¶ * (æ”¯æŒå›¾ç‰‡/GIF/è§†é¢‘)</label>
        <input id="file" type="file" accept="image/*,video/*" required />
        <div class="file-info" id="file-info">æœ€å¤§æ”¯æŒ 1GBï¼Œæ¨èè§†é¢‘æ ¼å¼ï¼šMP4/MOV/WebM</div>

        <div id="preview" class="preview">é€‰æ‹©æ–‡ä»¶åå°†æ˜¾ç¤ºé¢„è§ˆ</div>

        <div class="actions">
          <button id="submit-btn" type="submit">ä¸Šä¼ åˆ°å›¾åº“</button>
          <progress id="progress" value="0" max="100" style="display: none"></progress>
        </div>
        <div id="status" class="status"></div>
      </form>
    </div>

    <script>
      const WORKER_BASE_URL = "https://cyber-gallery-upload.jane-studio.workers.dev";
      const initUrl = `${WORKER_BASE_URL}/upload/init`;
      const completeUrl = `${WORKER_BASE_URL}/upload/complete`;

      const form = document.getElementById("upload-form");
      const fileInput = document.getElementById("file");
      const preview = document.getElementById("preview");
      const progress = document.getElementById("progress");
      const statusEl = document.getElementById("status");
      const submitBtn = document.getElementById("submit-btn");
      const dateInput = document.getElementById("date");
      const fileInfo = document.getElementById("file-info");

      dateInput.value = new Date().toISOString().slice(0, 10);

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) {
          preview.textContent = "é€‰æ‹©æ–‡ä»¶åå°†æ˜¾ç¤ºé¢„è§ˆ";
          fileInfo.textContent = "æœ€å¤§æ”¯æŒ 1GBï¼Œæ¨èè§†é¢‘æ ¼å¼ï¼šMP4/MOV/WebM";
          return;
        }

        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        fileInfo.textContent = `æ–‡ä»¶: ${file.name} (${sizeMB} MB)`;
        renderPreview(file);
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const file = fileInput.files[0];
        if (!file) return;

        const title = document.getElementById("title").value.trim();
        const date = formatDateForSheet(dateInput.value);
        const desc = document.getElementById("desc").value.trim();

        if (!title) {
          setStatus("è¯·è¾“å…¥æ ‡é¢˜", "error");
          return;
        }

        setStatus("å‡†å¤‡ä¸Šä¼ ...", "info");
        setUploading(true);

        try {
          const initRes = await fetch(initUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename: file.name,
              contentType: file.type || "application/octet-stream",
              size: file.size,
              title,
              date,
              desc,
            }),
          });

          if (!initRes.ok) {
            const error = await initRes.json();
            throw new Error(error.error || `åˆå§‹åŒ–å¤±è´¥: ${initRes.status}`);
          }

          const initData = await initRes.json();
          setStatus(`æ­£åœ¨ä¸Šä¼ æ–‡ä»¶ (${(file.size / 1024 / 1024).toFixed(2)} MB)...`, "info");

          await uploadToR2(initData.uploadUrl, file);

          setStatus("æ­£åœ¨ä¿å­˜åˆ°æ•°æ®åº“...", "info");
          const completeRes = await fetch(completeUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              objectKey: initData.objectKey,
              title,
              date,
              desc,
            }),
          });

          if (!completeRes.ok) {
            const error = await completeRes.json();
            throw new Error(error.error || `ä¿å­˜å¤±è´¥: ${completeRes.status}`);
          }

          const completeData = await completeRes.json();
          setStatus(
            `âœ… ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶å·²æ·»åŠ åˆ°å›¾åº“ã€‚<br><a href="${completeData.fileUrl}" target="_blank" rel="noopener">æŸ¥çœ‹æ–‡ä»¶</a>`,
            "success",
            true
          );

          form.reset();
          preview.textContent = "é€‰æ‹©æ–‡ä»¶åå°†æ˜¾ç¤ºé¢„è§ˆ";
          fileInfo.textContent = "æœ€å¤§æ”¯æŒ 1GBï¼Œæ¨èè§†é¢‘æ ¼å¼ï¼šMP4/MOV/WebM";
          progress.style.display = "none";
          progress.value = 0;
        } catch (error) {
          setStatus(`âŒ ${error.message || "ä¸Šä¼ å¤±è´¥"}`, "error");
        } finally {
          setUploading(false);
        }
      });

      function renderPreview(file) {
        preview.innerHTML = "";
        const url = URL.createObjectURL(file);

        if (file.type.startsWith("video/")) {
          const video = document.createElement("video");
          video.controls = true;
          video.src = url;
          video.style.maxHeight = "400px";
          preview.appendChild(video);
        } else if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = url;
          img.alt = "é¢„è§ˆ";
          preview.appendChild(img);
        } else {
          preview.textContent = "è¯¥æ–‡ä»¶ç±»å‹æ— æ³•é¢„è§ˆ";
        }
      }

      function uploadToR2(uploadUrl, file) {
        return new Promise((resolve, reject) => {
          progress.style.display = "block";
          progress.value = 0;

          const xhr = new XMLHttpRequest();
          xhr.open("PUT", uploadUrl, true);
          xhr.setRequestHeader("Content-Type", file.type || "application/octet-stream");

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percent = Math.round((event.loaded / event.total) * 100);
              progress.value = percent;
            }
          };

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve();
            } else {
              reject(new Error(`R2 ä¸Šä¼ å¤±è´¥: ${xhr.status}`));
            }
          };

          xhr.onerror = () => reject(new Error("ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ ä¸­æ–­"));
          xhr.send(file);
        });
      }

      function formatDateForSheet(value) {
        if (!value) return "";
        return value.replace(/-/g, ".");
      }

      function setUploading(isUploading) {
        submitBtn.disabled = isUploading;
        fileInput.disabled = isUploading;
      }

      function setStatus(message, type, allowHtml) {
        statusEl.className = `status ${type || ""} show`;
        if (allowHtml) {
          statusEl.innerHTML = message;
        } else {
          statusEl.textContent = message;
        }
      }
    </script>
  </body>
</html>
